<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gift EXP</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {background:#0d0d1f; color:#d0d0ff; font-family:sans-serif; margin:0; padding:0; min-height:100vh;}
    .top {background:#1a1a3a; padding:12px; display:flex; align-items:center; border-bottom:1px solid #333;}
    .avatar {width:50px; height:50px; border-radius:50%; border:2px solid #00aaff; margin-right:12px;}
    .name {font-size:1.3em; font-weight:bold;}
    .level {color:#00aaff; font-size:1em;}
    .balance {text-align:center; font-size:1.4em; margin:15px 0; color:#00aaff;}
    .recharge {background:#00aaff; color:white; border:none; padding:14px; font-size:1.3em; border-radius:12px; width:90%; margin:10px auto; display:block;}
    .ref-card {background:linear-gradient(#00aaff, #0077cc); margin:15px; padding:15px; border-radius:12px; text-align:center; color:white;}
    .ref-btn {background:#ffffff20; color:white; padding:12px; border:none; border-radius:20px; font-size:1.2em; width:100%; margin-top:10px;}
    .tabs {display:flex; justify-content:space-around; background:#111; padding:8px 0; position:fixed; bottom:0; left:0; right:0; border-top:1px solid #333; z-index:1000;}
    .tab-btn {background:none; border:none; color:#aaa; font-size:1em; padding:8px; flex:1; text-align:center; cursor:pointer;}
    .tab-btn.active {color:#ffffff; border-bottom:3px solid #ffd700;}
    .content {padding:15px; padding-bottom:90px;}
    .bets {display:flex; justify-content:center; gap:20px; margin:20px 0;}
    .bet-btn {background:#ff3366; color:white; border:none; padding:12px 24px; font-size:1.2em; border-radius:12px; cursor:pointer;}
    .bet-btn.active {background:#ffd700; color:#000;}
    .go-btn {background:#00ff88; color:#000; padding:16px; font-size:1.6em; border:none; border-radius:20px; width:90%; margin:20px auto; display:block; font-weight:bold; transition:opacity 0.3s;}
    .go-btn:disabled {background:#555; opacity:0.6;}
    #reel-container {overflow:hidden; height:160px; margin:30px 0; position:relative; background:#111; border-radius:12px; border:2px solid #333;}
    #reel {display:flex; position:absolute; left:0; transition:left 2.5s cubic-bezier(0.25, 0.1, 0.25, 1);}
    .prize {width:160px; height:160px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:6em; background:#1a1a3a; border:1px solid #444;}
    .center-line {position:absolute; top:0; bottom:0; left:50%; width:6px; background:#ffd700; transform:translateX(-50%); pointer-events:none; box-shadow:0 0 30px #ffd700, 0 0 60px #ffaa00; z-index:5;}
    #result {font-size:2em; text-align:center; margin:20px 0; font-weight:bold; min-height:60px;}
    .win {color:#00ffaa; animation:blink 1.2s infinite;}
    .lose {color:#ff6666;}
    .chances-row {display:flex; overflow-x:auto; gap:15px; padding:10px 0; white-space:nowrap; scrollbar-width:thin;}
    .chance-item {min-width:100px; text-align:center; background:#1a1a3a; padding:10px; border-radius:12px;}
    .chance-emoji {font-size:40px;}
    .chance-pct {font-size:14px; color:#00ff9d;}
    .chance-price {font-size:14px; color:#ffd700;}
    .inventory-list {list-style:none; padding:0;}
    .inventory-item {background:#1a1a3a; margin:10px 0; padding:15px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;}
    .inv-emoji {font-size:40px; margin-right:15px;}
    .inv-info {flex:1;}
    .inv-buttons button {margin-left:10px; padding:8px 16px; border-radius:8px; cursor:pointer;}
    .sell-btn {background:#ff3366; color:white; border:none;}
    .withdraw-btn {background:#00aaff; color:white; border:none;}
    .exp-section {text-align:center; padding:20px;}
    .exp-bar {background:#333; border:2px solid #ffd700; border-radius:10px; height:20px; margin:10px auto; width:80%; max-width:400px;}
    .exp-progress {background:linear-gradient(to right, #ffd700, #ffaa00); height:100%; width:0%; border-radius:8px; transition:width 0.5s;}
    .season-title {font-size:1.8em; color:#ffd700; margin:10px 0;}
    .premium-btn {background:#00aaff; color:white; border:none; padding:12px 24px; font-size:1.2em; border-radius:12px; margin:15px auto; display:block; width:fit-content;}
    .reward-grid {display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin:20px 0;}
    .reward-card {background:#1a1a3a; padding:15px; border-radius:12px; text-align:center;}
    .reward-premium {border:2px solid #ffd700; background:#2a2a4a;}
    .reward-btn {background:#ff3366; color:white; border:none; padding:8px 16px; border-radius:8px; margin-top:10px; cursor:pointer;}
    .reward-btn:disabled {background:#555; cursor:not-allowed;}
    @keyframes blink {0%,100%{opacity:1;} 50%{opacity:0.7;}}
  </style>
</head>
<body>
  <div class="top">
    <img class="avatar" id="user-avatar" src="https://via.placeholder.com/50?text=Av" alt="Avatar">
    <div>
      <div class="name" id="user-name">–¢–≤–æ–π –ù–∏–∫ üçÖ</div>
      <div class="level">–£—Ä. <span id="level">2</span></div>
    </div>
  </div>

  <div class="balance">–ë–∞–ª–∞–Ω—Å: <span id="stars">92</span> ‚òÖ</div>
  <button class="recharge" onclick="alert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Stars')">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>

  <div class="ref-card">
    –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π 10% –æ—Ç –∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤!
    <button class="ref-btn" onclick="alert('–°—Å—ã–ª–∫–∞: t.me/—Ç–≤–æ–π–±–æ—Ç?start=ref_12345')">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
  </div>

  <div class="tabs">
    <button class="tab-btn" onclick="showTab('play')">–ò–≥—Ä–∞—Ç—å</button>
    <button class="tab-btn" onclick="showTab('gifts')">–ü–æ–¥–∞—Ä–∫–∏</button>
    <button class="tab-btn active" onclick="showTab('exp')">EXP</button>
    <button class="tab-btn" onclick="showTab('friends')">–î—Ä—É–∑—å—è</button>
    <button class="tab-btn" onclick="showTab('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
  </div>

  <div id="play" class="content">
    <div class="bets">
      <button class="bet-btn active" data-bet="25">25 ‚òÖ</button>
      <button class="bet-btn" data-bet="50">50 ‚òÖ</button>
    </div>
    <button class="go-btn" onclick="openCase()">–ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç, Go! <span id="bet-display">25</span> ‚òÖ</button>

    <div id="reel-container">
      <div id="reel"></div>
      <div class="center-line"></div>
    </div>

    <div id="result"></div>

    <div class="chances-row" id="chances-row"></div>
  </div>

  <div id="gifts" class="content" style="display:none;">
    <h3>–¢–≤–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
    <ul id="inventory-list" class="inventory-list"></ul>
  </div>

  <div id="exp" class="content" style="display:none;">
    <div class="exp-section">
      <div class="season-title">Spring Season</div>
      <button class="premium-btn" onclick="alert('–ü–æ–∫—É–ø–∫–∞ Premium –∑–∞ 99 ‚òÖ ‚Äî —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞')">–ö—É–ø–∏—Ç—å Premium ‚Äî 99 ‚òÖ</button>

      <div>–¢–≤–æ–π XP: <span id="current-xp">0</span></div>
      <div class="exp-bar">
        <div id="exp-progress" class="exp-progress"></div>
      </div>

      <div class="reward-grid">
        <!-- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã -->
        <div class="reward-card">
          <div>5 Stars</div>
          <div>100 XP</div>
          <button class="reward-btn" onclick="claimFreeReward(0)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <div class="reward-card">
          <div>Bear</div>
          <div>200 XP</div>
          <button class="reward-btn" onclick="claimFreeReward(1)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <div class="reward-card">
          <div>15 Stars</div>
          <div>300 XP</div>
          <button class="reward-btn" onclick="claimFreeReward(2)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <div class="reward-card">
          <div>Bear Upgrade</div>
          <div>400 XP</div>
          <button class="reward-btn" onclick="claimFreeReward(3)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>

        <!-- –ü—Ä–µ–º–∏—É–º-–Ω–∞–≥—Ä–∞–¥—ã -->
        <div class="reward-card reward-premium">
          <div>Bear</div>
          <div>100 XP</div>
          <button class="reward-btn" onclick="claimPremiumReward(0)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <div class="reward-card reward-premium">
          <div>Heart</div>
          <div>200 XP</div>
          <button class="reward-btn" onclick="claimPremiumReward(1)">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="friends" class="content" style="display:none;">
    <h3>–î—Ä—É–∑—å—è</h3>
    <p>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 0 | –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 ‚òÖ</p>
  </div>

  <div id="history" class="content" style="display:none;">
    <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
    <ul id="history-list" class="history-list"></ul>
  </div>

  <audio id="spin-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.wav"></audio>
  <audio id="win-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.wav"></audio>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    let stars = parseInt(localStorage.getItem('gift_exp_stars')) || 92;
    let currentBet = 25;
    let history = JSON.parse(localStorage.getItem('gift_exp_history')) || [];
    let inventory = JSON.parse(localStorage.getItem('gift_exp_inventory')) || [];
    let xp = parseInt(localStorage.getItem('gift_exp_xp')) || 0;
    let isSpinning = false;

    const user = Telegram.WebApp.initDataUnsafe.user;
    if (user) {
      document.getElementById('user-name').innerHTML = (user.username || user.first_name) + ' üçÖ';
      if (user.photo_url) document.getElementById('user-avatar').src = user.photo_url;
    }

    const gifts = [
      {name: 'Diamond', emoji: 'üíé', price: 100},
      {name: 'Trophy', emoji: 'üèÜ', price: 100},
      {name: 'Ring', emoji: 'üíç', price: 100},
      {name: 'Rocket', emoji: 'üöÄ', price: 50},
      {name: 'Champagne', emoji: 'üçæ', price: 50},
      {name: 'Bouquet', emoji: 'üíê', price: 50},
      {name: 'Cake', emoji: 'üéÇ', price: 50},
      {name: 'Rose', emoji: 'üåπ', price: 25},
      {name: 'Gift Box', emoji: 'üéÅ', price: 25},
      {name: 'Teddy', emoji: 'üß∏', price: 15},
      {name: 'Heart', emoji: 'üíù', price: 15}
    ];

    const chances = {
      25: {diamond: 0.5, trophy: 0.5, ring: 0.5, rocket: 3, champagne: 3, bouquet: 3, cake: 3, rose: 20, gift: 20, teddy: 24.5, heart: 24.5},
      50: {diamond: 1, trophy: 1, ring: 1, rocket: 5, champagne: 5, bouquet: 5, cake: 5, rose: 18, gift: 18, teddy: 23, heart: 23}
    };

    document.getElementById('stars').innerHTML = stars;
    document.getElementById('current-xp').innerHTML = xp;
    updateExpProgress();

    function updateExpProgress() {
      const progress = (xp % 100) / 100 * 100;
      document.getElementById('exp-progress').style.width = progress + '%';
    }

    document.querySelectorAll('.bet-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentBet = parseInt(btn.dataset.bet);
        document.querySelector('.go-btn').textContent = `–ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç, Go! ${currentBet} ‚òÖ`;
        updateChances();
      });
    });

    function updateChances() {
      const row = document.getElementById('chances-row');
      row.innerHTML = '';
      gifts.forEach(g => {
        const item = document.createElement('div');
        item.className = 'chance-item';
        item.innerHTML = `
          <div class="chance-emoji">${g.emoji}</div>
          <div class="chance-pct">${chances[currentBet][g.name.toLowerCase()] || 0.1}%</div>
          <div class="chance-price">${g.price} ‚òÖ</div>
        `;
        row.appendChild(item);
      });
    }

    function showTab(tab) {
      document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
      document.getElementById(tab).style.display = 'block';
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'gifts') updateInventory();
    }

    function addHistory(entry) {
      history.push(entry);
      localStorage.setItem('gift_exp_history', JSON.stringify(history));
      const list = document.getElementById('history-list');
      list.innerHTML = '';
      history.slice(-5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        list.appendChild(li);
      });
    }

    function updateInventory() {
      const list = document.getElementById('inventory-list');
      list.innerHTML = '';
      if (inventory.length === 0) {
        list.innerHTML = '<p>–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤</p>';
        return;
      }
      inventory.forEach((gift, index) => {
        const item = document.createElement('li');
        item.className = 'inventory-item';
        item.innerHTML = `
          <div class="inv-emoji">${gift.emoji}</div>
          <div class="inv-info">
            <strong>${gift.name}</strong><br>
            –ü—Ä–æ–¥–∞–∂–∞: ${gift.price} ‚òÖ
          </div>
          <div>
            <button class="sell-btn" onclick="sellGift(${index})">–ü—Ä–æ–¥–∞—Ç—å</button>
            <button class="withdraw-btn" onclick="withdrawGift(${index})">–í—ã–≤–µ—Å—Ç–∏</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    function sellGift(index) {
      const gift = inventory[index];
      stars += gift.price;
      document.getElementById('stars').innerHTML = stars;
      localStorage.setItem('gift_exp_stars', stars);
      inventory.splice(index, 1);
      localStorage.setItem('gift_exp_inventory', JSON.stringify(inventory));
      updateInventory();
      addHistory(`–ü—Ä–æ–¥–∞–Ω ${gift.name} +${gift.price} ‚òÖ`);
      alert(`–ü—Ä–æ–¥–∞–Ω ${gift.name} –∑–∞ ${gift.price} ‚òÖ`);
    }

    function withdrawGift(index) {
      alert("–í—ã–≤–æ–¥ –ø–æ–¥–∞—Ä–∫–æ–≤ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–∏–º–∏—Ç–∞—Ü–∏—è)");
    }

    function claimFreeReward(index) {
      alert("–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ XP ‚Äî —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ");
    }

    function claimPremiumReward(index) {
      alert("–ü—Ä–µ–º–∏—É–º-–Ω–∞–≥—Ä–∞–¥–∞ ‚Äî –ø–æ–∫—É–ø–∫–∞ Premium –∑–∞ 99 ‚òÖ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞");
    }

    function openCase() {
      if (isSpinning) {
        alert("–ü–æ–¥–æ–∂–¥–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏!");
        return;
      }

      if (stars < currentBet) {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Stars!");
        return;
      }

      isSpinning = true;
      const goBtn = document.querySelector('.go-btn');
      goBtn.disabled = true;
      goBtn.style.opacity = '0.5';
      goBtn.textContent = "–ö—Ä—É—Ç–∏—Ç—Å—è...";

      stars -= currentBet;
      addHistory(`–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞ -${currentBet} ‚òÖ`);
      document.getElementById('result').innerHTML = '';
      document.getElementById('stars').innerHTML = stars;

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
      const rand = Math.random() * 100;
      let cumChance = 0;
      let selectedGift = gifts[9];
      for (let g of gifts) {
        cumChance += chances[currentBet][g.name.toLowerCase()] || 0.1;
        if (rand < cumChance) {
          selectedGift = g;
          break;
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
      inventory.push(selectedGift);
      localStorage.setItem('gift_exp_inventory', JSON.stringify(inventory));

      // –°–±—Ä–æ—Å –ª–µ–Ω—Ç—ã
      const reel = document.getElementById('reel');
      reel.style.transition = 'none';
      reel.style.left = '0px';
      reel.offsetHeight;

      reel.innerHTML = '';

      const prizeEmojis = gifts.map(g => g.emoji);
      for (let i = 0; i < 80; i++) {
        const div = document.createElement('div');
        div.className = 'prize';
        div.innerHTML = prizeEmojis[Math.floor(Math.random() * prizeEmojis.length)];
        reel.appendChild(div);
      }
      const finalDiv = document.createElement('div');
      finalDiv.className = 'prize';
      finalDiv.innerHTML = selectedGift.emoji;
      reel.appendChild(finalDiv);
      for (let i = 0; i < 80; i++) {
        const div = document.createElement('div');
        div.className = 'prize';
        div.innerHTML = prizeEmojis[Math.floor(Math.random() * prizeEmojis.length)];
        reel.appendChild(div);
      }

      const prizeWidth = 160;
      const containerWidth = document.getElementById('reel-container').offsetWidth;
      const centerOffset = (containerWidth - prizeWidth) / 2;
      const totalLeftWidth = 80 * prizeWidth;
      const offset = - (totalLeftWidth - centerOffset + prizeWidth / 2);

      reel.style.transition = 'left 2.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
      reel.style.left = offset + 'px';

      document.getElementById('spin-sound').play();

      setTimeout(() => {
        document.getElementById('result').innerHTML = `<span class="win">${selectedGift.emoji} ${selectedGift.name} +${selectedGift.price} ‚òÖ (–≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ)</span>`;
        isSpinning = false;
        goBtn.disabled = false;
        goBtn.style.opacity = '1';
        goBtn.textContent = `–ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç, Go! ${currentBet} ‚òÖ`;
      }, 2700);
    }

    updateChances();
    showTab('play');
  </script>
</body>
</html>
